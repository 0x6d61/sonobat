import { describe, it, expect, beforeEach } from 'vitest';
import Database from 'better-sqlite3';
import crypto from 'node:crypto';
import { migrateDatabase } from '../../../src/db/migrate.js';
import { VulnerabilityRepository } from '../../../src/db/repository/vulnerability-repository.js';
import { HostRepository } from '../../../src/db/repository/host-repository.js';
import { ArtifactRepository } from '../../../src/db/repository/artifact-repository.js';
import { ServiceRepository } from '../../../src/db/repository/service-repository.js';
import type { Vulnerability } from '../../../src/types/entities.js';
import type { CreateVulnerabilityInput } from '../../../src/types/repository.js';

// ---------------------------------------------------------------------------
// ヘルパー
// ---------------------------------------------------------------------------

/** テスト用の ISO 8601 タイムスタンプを返す */
function now(): string {
  return new Date().toISOString();
}

// ---------------------------------------------------------------------------
// テスト
// ---------------------------------------------------------------------------

describe('VulnerabilityRepository', () => {
  let db: InstanceType<typeof Database>;
  let repo: VulnerabilityRepository;
  let serviceId: string;
  let artifactId: string;

  beforeEach(() => {
    db = new Database(':memory:');
    migrateDatabase(db);
    repo = new VulnerabilityRepository(db);

    // 親レコードを作成: host → artifact → service
    const hostRepo = new HostRepository(db);
    const artifactRepo = new ArtifactRepository(db);
    const serviceRepo = new ServiceRepository(db);

    const host = hostRepo.create({
      authorityKind: 'IP',
      authority: '10.0.0.1',
      resolvedIpsJson: '[]',
    });

    const artifact = artifactRepo.create({
      tool: 'nmap',
      kind: 'tool_output',
      path: '/tmp/nmap-scan.xml',
      capturedAt: now(),
    });
    artifactId = artifact.id;

    const service = serviceRepo.create({
      hostId: host.id,
      transport: 'tcp',
      port: 80,
      appProto: 'http',
      protoConfidence: 'high',
      state: 'open',
      evidenceArtifactId: artifact.id,
    });
    serviceId = service.id;
  });

  it('create — Vulnerability を作成して返す', () => {
    const input: CreateVulnerabilityInput = {
      serviceId,
      vulnType: 'sqli',
      title: 'SQL Injection',
      severity: 'critical',
      confidence: 'high',
      evidenceArtifactId: artifactId,
    };

    const vuln: Vulnerability = repo.create(input);

    expect(vuln.id).toBeDefined();
    expect(vuln.id).toMatch(
      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/,
    );
    expect(vuln.serviceId).toBe(serviceId);
    expect(vuln.vulnType).toBe('sqli');
    expect(vuln.title).toBe('SQL Injection');
    expect(vuln.severity).toBe('critical');
    expect(vuln.confidence).toBe('high');
    expect(vuln.evidenceArtifactId).toBe(artifactId);
    expect(vuln.createdAt).toBeDefined();
  });

  it('findById — 存在する Vulnerability を取得する', () => {
    const input: CreateVulnerabilityInput = {
      serviceId,
      vulnType: 'xss',
      title: 'Reflected XSS',
      severity: 'high',
      confidence: 'medium',
      evidenceArtifactId: artifactId,
    };

    const created = repo.create(input);
    const found = repo.findById(created.id);

    expect(found).toBeDefined();
    expect(found!.id).toBe(created.id);
    expect(found!.serviceId).toBe(created.serviceId);
    expect(found!.vulnType).toBe(created.vulnType);
    expect(found!.title).toBe(created.title);
    expect(found!.severity).toBe(created.severity);
    expect(found!.confidence).toBe(created.confidence);
    expect(found!.evidenceArtifactId).toBe(created.evidenceArtifactId);
    expect(found!.createdAt).toBe(created.createdAt);
  });

  it('findById — 存在しない場合 undefined を返す', () => {
    const found = repo.findById(crypto.randomUUID());

    expect(found).toBeUndefined();
  });

  it('findByServiceId — serviceId で一覧取得', () => {
    const input1: CreateVulnerabilityInput = {
      serviceId,
      vulnType: 'sqli',
      title: 'SQL Injection',
      severity: 'critical',
      confidence: 'high',
      evidenceArtifactId: artifactId,
    };
    const input2: CreateVulnerabilityInput = {
      serviceId,
      vulnType: 'xss',
      title: 'Reflected XSS',
      severity: 'high',
      confidence: 'medium',
      evidenceArtifactId: artifactId,
    };

    const vuln1 = repo.create(input1);
    const vuln2 = repo.create(input2);

    const results = repo.findByServiceId(serviceId);

    expect(results).toHaveLength(2);
    const ids = results.map((v) => v.id);
    expect(ids).toContain(vuln1.id);
    expect(ids).toContain(vuln2.id);
  });

  it('findByServiceId — severity で絞り込み', () => {
    const inputCritical: CreateVulnerabilityInput = {
      serviceId,
      vulnType: 'sqli',
      title: 'SQL Injection',
      severity: 'critical',
      confidence: 'high',
      evidenceArtifactId: artifactId,
    };
    const inputLow: CreateVulnerabilityInput = {
      serviceId,
      vulnType: 'info_disclosure',
      title: 'Information Disclosure',
      severity: 'low',
      confidence: 'high',
      evidenceArtifactId: artifactId,
    };

    const criticalVuln = repo.create(inputCritical);
    repo.create(inputLow);

    const results = repo.findByServiceId(serviceId, 'critical');

    expect(results).toHaveLength(1);
    expect(results[0].id).toBe(criticalVuln.id);
    expect(results[0].severity).toBe('critical');
  });

  it('findAll — 全 Vulnerability を取得する', () => {
    // 2つ目の service を作成
    const hostRepo = new HostRepository(db);
    const artifactRepo = new ArtifactRepository(db);
    const serviceRepo = new ServiceRepository(db);

    const host2 = hostRepo.create({
      authorityKind: 'IP',
      authority: '10.0.0.2',
      resolvedIpsJson: '[]',
    });
    const artifact2 = artifactRepo.create({
      tool: 'nmap',
      kind: 'tool_output',
      path: '/tmp/nmap-scan2.xml',
      capturedAt: now(),
    });
    const service2 = serviceRepo.create({
      hostId: host2.id,
      transport: 'tcp',
      port: 22,
      appProto: 'ssh',
      protoConfidence: 'high',
      state: 'open',
      evidenceArtifactId: artifact2.id,
    });

    const vuln1 = repo.create({
      serviceId,
      vulnType: 'sqli',
      title: 'SQL Injection',
      severity: 'critical',
      confidence: 'high',
      evidenceArtifactId: artifactId,
    });
    const vuln2 = repo.create({
      serviceId: service2.id,
      vulnType: 'xss',
      title: 'Reflected XSS',
      severity: 'high',
      confidence: 'medium',
      evidenceArtifactId: artifact2.id,
    });

    const results = repo.findAll();

    expect(results).toHaveLength(2);
    const ids = results.map((v) => v.id);
    expect(ids).toContain(vuln1.id);
    expect(ids).toContain(vuln2.id);
  });

  it('findAll — severity で絞り込み', () => {
    repo.create({
      serviceId,
      vulnType: 'sqli',
      title: 'SQL Injection',
      severity: 'critical',
      confidence: 'high',
      evidenceArtifactId: artifactId,
    });
    repo.create({
      serviceId,
      vulnType: 'info_disclosure',
      title: 'Information Disclosure',
      severity: 'low',
      confidence: 'high',
      evidenceArtifactId: artifactId,
    });

    const results = repo.findAll('critical');

    expect(results).toHaveLength(1);
    expect(results[0].severity).toBe('critical');
  });

  it('findAll — Vulnerability がない場合は空配列を返す', () => {
    const results = repo.findAll();
    expect(results).toHaveLength(0);
  });

  it('delete — Vulnerability を削除する', () => {
    const input: CreateVulnerabilityInput = {
      serviceId,
      vulnType: 'rce',
      title: 'Remote Code Execution',
      severity: 'critical',
      confidence: 'high',
      evidenceArtifactId: artifactId,
    };

    const created = repo.create(input);

    const deleted = repo.delete(created.id);

    expect(deleted).toBe(true);

    const found = repo.findById(created.id);
    expect(found).toBeUndefined();
  });
});
