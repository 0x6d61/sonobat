import { describe, it, expect, beforeEach } from 'vitest';
import Database from 'better-sqlite3';
import crypto from 'node:crypto';
import { migrateDatabase } from '../../../src/db/migrate.js';
import { CveRepository } from '../../../src/db/repository/cve-repository.js';
import { HostRepository } from '../../../src/db/repository/host-repository.js';
import { ArtifactRepository } from '../../../src/db/repository/artifact-repository.js';
import { ServiceRepository } from '../../../src/db/repository/service-repository.js';
import { VulnerabilityRepository } from '../../../src/db/repository/vulnerability-repository.js';
import type { Cve } from '../../../src/types/entities.js';
import type { CreateCveInput } from '../../../src/types/repository.js';

// ---------------------------------------------------------------------------
// ヘルパー
// ---------------------------------------------------------------------------

/** テスト用の ISO 8601 タイムスタンプを返す */
function now(): string {
  return new Date().toISOString();
}

// ---------------------------------------------------------------------------
// テスト
// ---------------------------------------------------------------------------

describe('CveRepository', () => {
  let db: InstanceType<typeof Database>;
  let repo: CveRepository;
  let vulnerabilityId: string;

  beforeEach(() => {
    db = new Database(':memory:');
    migrateDatabase(db);
    repo = new CveRepository(db);

    // 親レコードを作成: host → artifact → service → vulnerability
    const hostRepo = new HostRepository(db);
    const artifactRepo = new ArtifactRepository(db);
    const serviceRepo = new ServiceRepository(db);
    const vulnRepo = new VulnerabilityRepository(db);

    const host = hostRepo.create({
      authorityKind: 'IP',
      authority: '10.0.0.1',
      resolvedIpsJson: '[]',
    });

    const artifact = artifactRepo.create({
      tool: 'nmap',
      kind: 'tool_output',
      path: '/tmp/nmap-scan.xml',
      capturedAt: now(),
    });

    const service = serviceRepo.create({
      hostId: host.id,
      transport: 'tcp',
      port: 80,
      appProto: 'http',
      protoConfidence: 'high',
      state: 'open',
      evidenceArtifactId: artifact.id,
    });

    const vuln = vulnRepo.create({
      serviceId: service.id,
      vulnType: 'sqli',
      title: 'SQL Injection',
      severity: 'critical',
      confidence: 'high',
      evidenceArtifactId: artifact.id,
    });
    vulnerabilityId = vuln.id;
  });

  it('create — Cve を作成して返す', () => {
    const input: CreateCveInput = {
      vulnerabilityId,
      cveId: 'CVE-2024-12345',
      description: 'Critical SQL injection vulnerability in login form',
      cvssScore: 9.8,
      cvssVector: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H',
      referenceUrl: 'https://nvd.nist.gov/vuln/detail/CVE-2024-12345',
    };

    const cve: Cve = repo.create(input);

    expect(cve.id).toBeDefined();
    expect(cve.id).toMatch(
      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/,
    );
    expect(cve.vulnerabilityId).toBe(vulnerabilityId);
    expect(cve.cveId).toBe('CVE-2024-12345');
    expect(cve.description).toBe(
      'Critical SQL injection vulnerability in login form',
    );
    expect(cve.cvssScore).toBe(9.8);
    expect(cve.cvssVector).toBe(
      'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H',
    );
    expect(cve.referenceUrl).toBe(
      'https://nvd.nist.gov/vuln/detail/CVE-2024-12345',
    );
    expect(cve.createdAt).toBeDefined();
  });

  it('findById — 存在する Cve を取得する', () => {
    const input: CreateCveInput = {
      vulnerabilityId,
      cveId: 'CVE-2024-99999',
      description: 'Test vulnerability',
      cvssScore: 7.5,
      cvssVector: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N',
      referenceUrl: 'https://example.com/cve',
    };

    const created = repo.create(input);
    const found = repo.findById(created.id);

    expect(found).toBeDefined();
    expect(found!.id).toBe(created.id);
    expect(found!.vulnerabilityId).toBe(created.vulnerabilityId);
    expect(found!.cveId).toBe(created.cveId);
    expect(found!.description).toBe(created.description);
    expect(found!.cvssScore).toBe(created.cvssScore);
    expect(found!.cvssVector).toBe(created.cvssVector);
    expect(found!.referenceUrl).toBe(created.referenceUrl);
    expect(found!.createdAt).toBe(created.createdAt);
  });

  it('findById — 存在しない場合 undefined を返す', () => {
    const found = repo.findById(crypto.randomUUID());

    expect(found).toBeUndefined();
  });

  it('findByVulnerabilityId — vulnerabilityId で一覧取得', () => {
    const input1: CreateCveInput = {
      vulnerabilityId,
      cveId: 'CVE-2024-11111',
      description: 'First CVE',
      cvssScore: 9.8,
    };
    const input2: CreateCveInput = {
      vulnerabilityId,
      cveId: 'CVE-2024-22222',
      description: 'Second CVE',
      cvssScore: 8.1,
    };

    const cve1 = repo.create(input1);
    const cve2 = repo.create(input2);

    const results = repo.findByVulnerabilityId(vulnerabilityId);

    expect(results).toHaveLength(2);
    const ids = results.map((c) => c.id);
    expect(ids).toContain(cve1.id);
    expect(ids).toContain(cve2.id);
  });

  it('create — オプションフィールドが省略可能', () => {
    const input: CreateCveInput = {
      vulnerabilityId,
      cveId: 'CVE-2024-00001',
    };

    const cve: Cve = repo.create(input);

    expect(cve.id).toBeDefined();
    expect(cve.vulnerabilityId).toBe(vulnerabilityId);
    expect(cve.cveId).toBe('CVE-2024-00001');
    expect(cve.description).toBeUndefined();
    expect(cve.cvssScore).toBeUndefined();
    expect(cve.cvssVector).toBeUndefined();
    expect(cve.referenceUrl).toBeUndefined();
    expect(cve.createdAt).toBeDefined();
  });

  it('delete — Cve を削除する', () => {
    const input: CreateCveInput = {
      vulnerabilityId,
      cveId: 'CVE-2024-33333',
      description: 'To be deleted',
      cvssScore: 5.0,
    };

    const created = repo.create(input);

    const deleted = repo.delete(created.id);

    expect(deleted).toBe(true);

    const found = repo.findById(created.id);
    expect(found).toBeUndefined();
  });
});
